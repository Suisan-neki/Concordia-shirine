# 第5章：水面振動の実装 - 祠に生命を吹き込む

お待たせしました！いよいよフェーズ2「水面振動」の実装に入ります。この章では、振動モーターを使って水盤に波紋を作り出し、祠がまるで呼吸しているかのような、生命感あふれる表現を加えます。

電子回路の組み立てが含まれますが、一つ一つ丁寧に解説しますので、ご安心ください。

## 5.1 部品の準備

まずは、この章で使用する電子部品を確認しましょう。

| 部品名 | 数量 | 備考 |
| :--- | :--- | :--- |
| uxcell DC振動モーター（DC 3V） | 1個 | 水盤を振動させる動力源 |
| Chanzon 2N2222A トランジスタ | 1個 | モーターを制御するスイッチ役 |
| 整流用ダイオード 1N4007 | 1個 | 回路を保護する重要な部品 |
| 抵抗 1kΩ | 1個 | Raspberry Piのピンを保護する |
| ブレッドボード | 1個 | はんだ付けなしで回路を組むための基板 |
| ジャンパーワイヤー（オス-オス） | 数本 | 部品同士を接続する |

## 5.2 回路の設計と理解

なぜ、モーターを直接Raspberry Piに繋いではいけないのでしょうか？それは、Raspberry Piのピン（GPIO）が流せる電流は非常に小さく、モーターを動かすにはパワー不足だからです。無理に接続すると、Raspberry Piが破損する恐れがあります。

そこで、**トランジスタ**を「スイッチ」として使います。GPIOからトランジスタに小さな「ON/OFF」信号を送ることで、より大きな電流を流してモーターを安全に制御します。

### 回路図

以下が今回作成する回路の図です。

```
[Raspberry Pi 4]

  GPIO 26 (Pin 37) ─[ 1kΩ 抵抗 ]─┬─ [トランジスタ 2N2222A (Base)]
                                │
  3.3V (Pin 1) ───────────────────┼─ [振動モーター] ─┬─ [トランジスタ (Collector)]
                                │                │
                                │                └─[ダイオード 1N4007]──┐ (※向きに注意)
                                │                                    │
  GND (Pin 39) ───────────────────┴────────────────────────────────────┴─ [トランジスタ (Emitter)]
```

### 各部品の役割

- **トランジスタ (2N2222A)**: スイッチ役。GPIO 26からの信号（電圧）がONになると、CollectorからEmitterへ電流が流れ、モーターが回転します。
- **ダイオード (1N4007)**: **逆起電力保護（フライバックダイオード）**。モーターはコイルなので、電源がOFFになった瞬間に逆向きの大きな電圧（逆起電力）が発生します。これがトランジスタやRaspberry Piを破壊する原因になるため、ダイオードをモーターと並列に接続し、逆起電力を安全に逃がす役割を担います。**非常に重要な保護部品です。**
- **抵抗 (1kΩ)**: 電流制限。GPIO 26からトランジスタのBaseに流れる電流を適切な量に制限し、GPIOピンを保護します。

## 5.3 ブレッドボードでの回路組み立て

はんだ付け不要のブレッドボードを使って、上記の回路を組み立てます。

### 準備：トランジスタの足の確認

2N2222Aトランジスタの平らな面を手前に向けたとき、足は左から **E (Emitter), B (Base), C (Collector)** となっています。これを間違えると動作しません。

```
   /───\
  /     \
 |       |
 | 2N2222A |
 |       |
  `-----´
  |  |  |
  E  B  C
 (エミッタ) (ベース) (コレクタ)
```

### 組み立て手順

1.  **トランジスタの配置**: ブレッドボードの中央の溝をまたぐように、トランジスタを差し込みます。

2.  **Emitterの接続**: トランジスタの **E (Emitter)** の足と同じ列にジャンパーワイヤーを差し、そのワイヤーをRaspberry Piの **GND (Pin 39など)** に接続します。

3.  **Baseの接続**: トランジスタの **B (Base)** の足と同じ列に **1kΩ抵抗** の片足を差し込みます。抵抗のもう片方の足にジャンパーワイヤーを接続し、そのワイヤーをRaspberry Piの **GPIO 26 (Pin 37)** に接続します。

4.  **Collectorの接続**: トランジスタの **C (Collector)** の足と同じ列に、**振動モーターの黒い線**を接続します。

5.  **モーターの電源接続**: **振動モーターの赤い線**を、Raspberry Piの **3.3V (Pin 1など)** に接続します。

6.  **ダイオードの接続**: **最も重要です**。ダイオードには向きがあります。**銀色の帯がある方（カソード）**を **3.3V側（モーターの赤い線側）**に、**帯がない方（アノード）**を **Collector側（モーターの黒い線側）**に接続します。つまり、モーターをまたぐように、モーターの赤い線と黒い線が接続されている列に、それぞれダイオードの足を差し込みます。

### 配線チェックリスト

- [ ] トランジスタの向きは正しいか？ (平らな面が手前でE, B, C)
- [ ] EmitterはRaspberry PiのGNDに接続されているか？
- [ ] Baseは1kΩ抵抗を介してGPIO 26に接続されているか？
- [ ] Collectorはモーターの黒い線に接続されているか？
- [ ] モーターの赤い線はRaspberry Piの3.3Vに接続されているか？
- [ ] **ダイオードの向きは正しいか？ (銀色の帯が3.3V側)**

## 5.4 振動モーターのテストコード

PWM（パルス幅変調）を使って、モーターの振動の強さを制御します。

以下のコードを `/home/pi/concordia-shrine-pi/vibration_test.py` として保存します。

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
振動モーター PWM制御テスト
"""

import RPi.GPIO as GPIO
import time

# 使用するGPIOピン
VIBRATION_MOTOR_PIN = 26

def setup():
    """GPIOのセットアップ"""
    GPIO.setmode(GPIO.BCM)  # GPIO番号で指定
    GPIO.setup(VIBRATION_MOTOR_PIN, GPIO.OUT)
    GPIO.output(VIBRATION_MOTOR_PIN, GPIO.LOW) # 初期状態はOFF

def test_vibration():
    """振動の強さを変えながらテスト"""
    # PWMオブジェクトを作成 (周波数: 100Hz)
    pwm = GPIO.PWM(VIBRATION_MOTOR_PIN, 100)
    pwm.start(0) # Duty Cycle 0%で開始 (OFF)
    
    try:
        print("振動テストを開始します...")
        
        test_patterns = {
            "弱い振動 (20%)": 20,
            "中くらいの振動 (50%)": 50,
            "強い振動 (80%)": 80,
            "最大の振動 (100%)": 100
        }
        
        for name, duty_cycle in test_patterns.items():
            print(f"\n{name}")
            pwm.ChangeDutyCycle(duty_cycle) # Duty Cycleを変更
            time.sleep(3) # 3秒間振動
            
            pwm.ChangeDutyCycle(0) # 停止
            time.sleep(2) # 2秒間停止
            
        print("\nテスト完了")
        
    except KeyboardInterrupt:
        print("\n中断されました")
    finally:
        pwm.stop() # PWMを停止
        GPIO.cleanup() # GPIOをクリーンアップ

if __name__ == "__main__":
    setup()
    test_vibration()
```

### 実行方法

```bash
cd /home/pi/concordia-shrine-pi
python3 vibration_test.py
```

モーターが「弱い」「中くらい」「強い」「最大」の4段階で、それぞれ3秒間振動することを確認してください。

### トラブルシューティング

| 症状 | 原因 | 対処法 |
| :--- | :--- | :--- |
| 全く振動しない | 配線ミス | 配線チェックリストを再確認。特にトランジスタとダイオードの向き。 |
| 全く振動しない | GPIOピンの指定ミス | コードの`VIBRATION_MOTOR_PIN`が26になっているか確認。 |
| 常に振動している | トランジスタの故障または配線ミス | BaseとCollectorがショートしていないか確認。 |
| 振動が弱い | 電圧不足 | Raspberry Piの3.3Vではなく、5Vピンに接続してみる（自己責任で）。 |
| Piが再起動する | **逆起電力** | **ダイオードの接続を最優先で確認！** 向きが逆か、接続されていない可能性。 |

---

**お疲れ様でした！** これで、祠に生命の「鼓動」を与える準備が整いました。

次の「第6章：水面振動システムの統合」では、この振動モーター制御を既存の`shrine_controller.py`に組み込み、Webアプリケーションのシーンと連動させます。
