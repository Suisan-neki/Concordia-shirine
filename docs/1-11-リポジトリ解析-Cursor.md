# 1/11 リポジトリ解析 Cursor

このドキュメントは、2026年1月11日に実施したセキュリティ問題の修正内容と、その背景（なぜそのままだと問題だったか）を整理したものです。

## 概要

Concordia Shrineリポジトリに対して包括的なセキュリティ監査を実施し、8つの重要なセキュリティ問題を特定・修正しました。各修正は独立したコミットとして実装され、段階的にプッシュ可能な状態になっています。

## 修正内容一覧

1. [暗号化キーのデフォルト値削除](#1-暗号化キーのデフォルト値削除)
2. [アクセス制御の実装](#2-アクセス制御の実装)
3. [OAuth state検証の実装](#3-oauth-state検証の実装)
4. [CORS設定の見直し](#4-cors設定の見直し)
5. [環境変数の検証強化](#5-環境変数の検証強化)
6. [レート制限の改善](#6-レート制限の改善)
7. [セッション有効期限の短縮](#7-セッション有効期限の短縮)
8. [入力サニタイズの強化](#8-入力サニタイズの強化)

---

## 1. 暗号化キーのデフォルト値削除

### 変更点

- `server/security.ts`の`getEncryptionKey()`関数から、デフォルトキー`'default-secret-key-for-development'`を削除
- `server/_core/sdk.ts`の`getSessionSecret()`関数にも同様の検証を追加
- 環境変数`JWT_SECRET`が未設定または空の場合、エラーを投げるように変更

### なぜ問題だったか

**重大なセキュリティリスク：**

1. **本番環境での脆弱性**
   - デフォルトキーが使用されると、すべてのインスタンスで同じ暗号化キーが使われる
   - 攻撃者がデフォルトキーを知っていれば、すべての暗号化データを復号できる
   - 開発環境と本番環境で同じキーが使われる可能性がある

2. **設定ミスの検出不可**
   - 環境変数が設定されていなくても、アプリケーションが正常に動作してしまう
   - 本番環境で誤ってデフォルトキーが使われていても、エラーや警告が出ない
   - セキュリティインシデントが発生するまで問題に気づけない

3. **コンプライアンス違反**
   - 多くのセキュリティ標準（PCI-DSS、SOC 2等）では、デフォルト認証情報の使用を禁止している
   - 監査で指摘される可能性が高い

### 修正後の動作

- アプリケーション起動時に`JWT_SECRET`が必須となる
- 未設定の場合は明確なエラーメッセージが表示され、起動が停止する
- 設定ミスを早期に検出できる

---

## 2. アクセス制御の実装

### 変更点

- `server/security.ts`の`verifyAccess()`関数を実装
- 以前は常に`true`を返していたが、実際の権限チェックを追加
- リソースタイプ（`session`、`user`、`security_summary`）に応じた適切な権限チェックを実装
- データベースからユーザー情報とリソース情報を取得して、所有者確認とadmin権限チェックを実施

### なぜ問題だったか

**重大な認可の欠如：**

1. **任意のリソースへのアクセス可能**
   - すべてのユーザーがすべてのセッションにアクセスできてしまう
   - 他のユーザーのプライベートデータを閲覧・操作できる
   - データ漏洩やプライバシー侵害のリスク

2. **ロールベースアクセス制御（RBAC）の無効化**
   - admin権限のチェックが機能していない
   - 一般ユーザーがadmin専用機能にアクセスできる可能性

3. **監査ログの信頼性低下**
   - アクセス許可/拒否のログが記録されていても、実際には常に許可されていた
   - セキュリティインシデントの調査が困難

### 修正後の動作

- セッションへのアクセスは、所有者またはadminのみ許可
- ユーザー情報へのアクセスは、本人またはadminのみ許可
- セキュリティサマリーへのアクセスも適切に制御
- アクセス拒否時は必ずログに記録され、監査可能

---

## 3. OAuth state検証の実装

### 変更点

- `server/_core/oauth.ts`にOAuth stateストレージと検証機能を追加
- CSRF対策として、ランダムなCSRFトークンを生成してstateパラメータに含める
- コールバック時にstateを検証し、有効期限（10分）とワンタイム使用をチェック
- `generateOAuthState()`関数をエクスポートして、OAuth開始時に使用可能に

### なぜ問題だったか

**CSRF（Cross-Site Request Forgery）攻撃のリスク：**

1. **stateパラメータの検証不足**
   - stateパラメータの存在確認のみで、値の検証をしていなかった
   - 攻撃者が任意のstateパラメータでコールバックを呼び出せる
   - OAuth認証フローを悪用される可能性

2. **リダイレクト攻撃**
   - 攻撃者が被害者のブラウザでOAuth認証を開始し、自分のサイトにリダイレクトできる
   - 認証トークンが攻撃者のサイトに送信される可能性

3. **セッションハイジャック**
   - CSRF攻撃により、攻撃者のアカウントで被害者がログインしてしまう
   - 被害者のアカウントが乗っ取られるリスク

### 修正後の動作

- OAuth開始時に暗号学的に安全なCSRFトークンを生成
- stateパラメータにCSRFトークンとredirectUriを含める
- コールバック時にstateを検証し、有効期限とワンタイム使用をチェック
- 検証失敗時は403エラーを返し、CSRF攻撃をブロック

---

## 4. CORS設定の見直し

### 変更点

- Lambda関数（`realtime_transcribe`、`coach`）のCORSヘッダーを修正
- `Access-Control-Allow-Origin: *`を削除し、環境変数`ALLOWED_ORIGINS`から許可されたオリジンのみ許可
- リクエストの`Origin`ヘッダーをチェックし、許可リストに含まれる場合のみCORSヘッダーを返す
- OPTIONSリクエスト（プリフライト）の処理を追加

### なぜ問題だったか

**任意のオリジンからのアクセス許可：**

1. **クロスサイト攻撃のリスク**
   - すべてのWebサイトからAPIにアクセスできる
   - 悪意のあるWebサイトがユーザーのブラウザ経由でAPIを呼び出せる
   - CSRF攻撃やデータ窃取のリスク

2. **認証情報の漏洩**
   - ブラウザが自動的にCookieや認証ヘッダーを送信する可能性
   - 攻撃者のサイトから認証済みリクエストを送信できる

3. **APIの悪用**
   - レート制限を回避するために、複数のオリジンから分散してリクエストを送信できる
   - コスト増加やサービス停止攻撃のリスク

### 修正後の動作

- 環境変数`ALLOWED_ORIGINS`で許可されたオリジンのみCORSを許可
- リクエストのOriginが許可リストにない場合は、CORSヘッダーを返さない
- ブラウザがクロスオリジンリクエストをブロックする
- セキュアなオリジンのみからアクセス可能

---

## 5. 環境変数の検証強化

### 変更点

- `server/_core/env.ts`に`validateEnv()`関数を追加
- 起動時に必須環境変数（`JWT_SECRET`、`DATABASE_URL`、`VITE_APP_ID`）を検証
- 本番環境では推奨環境変数（`ALLOWED_ORIGINS`、認証設定）の警告を表示
- 必須環境変数が未設定の場合は、エラーを投げて起動を停止

### なぜ問題だったか

**設定ミスの検出不可：**

1. **サイレントフェイル**
   - 環境変数が設定されていなくても、空文字列で続行してしまう
   - 本番環境で重要な設定が欠けていても、エラーが出ない
   - 問題が発生するまで気づけない

2. **デバッグの困難さ**
   - 設定ミスが原因のエラーが、別の場所で発生する
   - 根本原因の特定に時間がかかる
   - 開発効率の低下

3. **セキュリティ設定の不備**
   - CORS設定が未設定でも動作してしまう
   - 認証設定が不完全でも起動してしまう
   - セキュリティホールが残る可能性

### 修正後の動作

- 起動時に必須環境変数をチェックし、未設定の場合は明確なエラーメッセージを表示
- 本番環境では推奨設定の警告を表示
- 設定ミスを早期に検出し、問題を防ぐ

---

## 6. レート制限の改善

### 変更点

- `server/security.ts`のレート制限ストレージに自動クリーンアップ機能を追加
- リセット時刻から1分以上経過したレコードを定期的に削除
- 5分ごとにクリーンアップを実行
- Redis移行のためのTODOコメントを追加

### なぜ問題だったか

**メモリリークとスケーラビリティの問題：**

1. **メモリリーク**
   - 期限切れのレート制限レコードが削除されず、メモリに蓄積される
   - 長時間稼働するとメモリ使用量が増加し続ける
   - サーバーのクラッシュやパフォーマンス低下のリスク

2. **分散環境での無効化**
   - メモリベースの実装では、複数のインスタンス間でレート制限を共有できない
   - ロードバランサー経由でリクエストが分散すると、レート制限が機能しない
   - DDoS攻撃に対する防御が弱い

3. **サーバー再起動でのリセット**
   - サーバー再起動でレート制限の状態が失われる
   - 攻撃者が再起動後に再度攻撃できる

### 修正後の動作

- 期限切れレコードが自動的に削除され、メモリリークを防止
- 将来のRedis移行に向けた準備
- より安定したレート制限機能

---

## 7. セッション有効期限の短縮

### 変更点

- `shared/const.ts`の`SESSION_EXPIRY_MS`を7日に変更（以前は365日）
- `ONE_YEAR_MS`は後方互換性のため残すが、`SESSION_EXPIRY_MS`を参照するように変更
- 非推奨マークを追加

### なぜ問題だったか

**トークン漏洩時のリスク拡大：**

1. **長期間のリスク**
   - セッショントークンが漏洩すると、1年間有効なまま
   - 攻撃者が長期間にわたってアカウントにアクセスできる
   - 被害が拡大する可能性

2. **検出の遅れ**
   - トークン漏洩に気づいても、1年間有効なトークンを無効化できない
   - パスワード変更だけでは不十分
   - セッションの強制ログアウトが必要

3. **コンプライアンス**
   - 多くのセキュリティ標準では、セッション有効期限を短くすることが推奨されている
   - 長期間のセッションは監査で指摘される可能性

### 修正後の動作

- セッション有効期限が7日に短縮され、トークン漏洩時のリスクを軽減
- 定期的な再認証により、セキュリティが向上
- より安全なセッション管理

---

## 8. 入力サニタイズの強化

### 変更点

- `server/security.ts`の`sanitizeInput()`関数を強化
- 制御文字の除去を追加
- NoSQLインジェクション対策（`$`と`.`のエスケープ）を追加
- JSONインジェクション対策（バックスラッシュと改行のエスケープ）を追加
- スクリプトインジェクション対策（`javascript:`、`data:`、`vbscript:`プロトコルの除去）を追加
- サニタイズタイプのログ記録を改善

### なぜ問題だったか

**複数のインジェクション攻撃への脆弱性：**

1. **NoSQLインジェクション**
   - `$`や`.`がエスケープされていないと、MongoDB等のNoSQLデータベースでクエリインジェクションが可能
   - データベースの任意のデータを読み取れる可能性
   - 認証をバイパスできる可能性

2. **JSONインジェクション**
   - メタデータにJSONが含まれる場合、JSONインジェクションが可能
   - データ構造を改ざんできる可能性
   - 予期しない動作を引き起こせる可能性

3. **スクリプトインジェクション**
   - `javascript:`や`data:`プロトコルが除去されていないと、XSS攻撃が可能
   - ユーザーのブラウザで任意のJavaScriptを実行できる
   - セッションのハイジャックやデータ窃取のリスク

4. **制御文字の処理不足**
   - 制御文字が適切に処理されていないと、予期しない動作を引き起こす可能性
   - ログインジェクションや改行インジェクションのリスク

### 修正後の動作

- 複数の攻撃ベクトルに対して包括的な保護を提供
- サニタイズタイプをログに記録し、どの種類の攻撃が試みられたかを追跡可能
- より安全な入力処理

---

## まとめ

今回のセキュリティ修正により、以下の改善が実現されました：

1. **認証・認可の強化** - デフォルトキーの削除、アクセス制御の実装、OAuth state検証
2. **ネットワークセキュリティの向上** - CORS設定の見直し、環境変数の検証
3. **セッション管理の改善** - 有効期限の短縮、レート制限の改善
4. **入力検証の強化** - 包括的なサニタイズ機能

これらの修正により、Concordia Shrineのセキュリティポスチャが大幅に向上しました。各修正は独立したコミットとして実装されているため、必要に応じて個別にレビューやロールバックが可能です。

## 今後の推奨事項

1. **Redisの導入** - レート制限を共有ストレージに移行して、複数インスタンス間で共有
2. **リフレッシュトークンの実装** - セッション有効期限をさらに短縮し、リフレッシュトークンでUXを維持
3. **セキュリティヘッダーの追加** - CSP、HSTS等のセキュリティヘッダーを追加
4. **定期的なセキュリティ監査** - 定期的にセキュリティ監査を実施し、新しい脆弱性を早期に発見

