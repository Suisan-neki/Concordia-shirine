name: Vulnerability Scan

on:
  schedule:
    - cron: "0 15 * * *"
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  issues: write

jobs:
  trivy:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Tokyo
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Trivy scan (JSON)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "json"
          output: "trivy-results.json"
          severity: "CRITICAL,HIGH"
          ignore-unfixed: true
          exit-code: "0"

      - name: Summarize findings
        id: findings
        run: |
          count=$(jq '[.Results[].Vulnerabilities[]?] | length' trivy-results.json)
          echo "count=$count" >> "$GITHUB_OUTPUT"

      - name: Create or update issues
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const data = JSON.parse(fs.readFileSync('trivy-results.json', 'utf8'));
            const results = data.Results || [];
            const findings = [];
            for (const result of results) {
              const vulns = result.Vulnerabilities || [];
              for (const vuln of vulns) {
                findings.push({
                  id: vuln.VulnerabilityID || 'UNKNOWN',
                  severity: vuln.Severity || 'UNKNOWN',
                  pkg: vuln.PkgName || 'unknown',
                  installed: vuln.InstalledVersion || 'unknown',
                  fixed: vuln.FixedVersion || 'unfixed',
                  title: vuln.Title || vuln.Description || 'No description',
                  target: result.Target || 'unknown'
                });
              }
            }

            const severityOrder = { CRITICAL: 0, HIGH: 1, MEDIUM: 2, LOW: 3, UNKNOWN: 4 };
            const severityLabel = {
              CRITICAL: '致命的',
              HIGH: '高',
              MEDIUM: '中',
              LOW: '低',
              UNKNOWN: '不明'
            };

            const now = new Date();
            const dateParts = new Intl.DateTimeFormat('ja-JP', {
              timeZone: 'Asia/Tokyo',
              year: 'numeric',
              month: '2-digit',
              day: '2-digit'
            }).formatToParts(now);
            const dateMap = Object.fromEntries(dateParts.map((part) => [part.type, part.value]));
            const dateStamp = `${dateMap.year}-${dateMap.month}-${dateMap.day}`;
            const timeStamp = new Intl.DateTimeFormat('ja-JP', {
              timeZone: 'Asia/Tokyo',
              hour: '2-digit',
              minute: '2-digit',
              second: '2-digit'
            }).format(now);

            const labelName = 'vulnerability-scan';

            const { owner, repo } = context.repo;

            async function ensureLabel() {
              try {
                await github.rest.issues.getLabel({ owner, repo, name: labelName });
              } catch (error) {
                if (error.status === 404) {
                  await github.rest.issues.createLabel({
                    owner,
                    repo,
                    name: labelName,
                    color: '0e8a16',
                    description: '自動脆弱性診断の結果'
                  });
                } else {
                  throw error;
                }
              }
            }

            await ensureLabel();

            const existingIssues = await github.paginate(github.rest.issues.listForRepo, {
              owner,
              repo,
              state: 'all',
              labels: labelName,
              per_page: 100
            });

            const existingByTitle = new Map(
              existingIssues.map((issue) => [issue.title, issue])
            );

            const currentTitles = new Set();

            for (const item of findings) {
              const title = `脆弱性: ${item.id} (${item.pkg}) @ ${item.target}`;
              currentTitles.add(title);

              const severityJa = severityLabel[item.severity] || item.severity;
              const fixed = item.fixed && item.fixed !== 'unfixed' ? item.fixed : 'なし';
              const action = fixed === 'なし' ? '監視' : '更新';

              const body = [
                '## 概要',
                '',
                `- 重要度: ${severityJa}`,
                `- 検出ID: ${item.id}`,
                `- パッケージ: ${item.pkg}`,
                `- インストール済み: ${item.installed}`,
                `- 修正版: ${fixed}`,
                `- 対象: ${item.target}`,
                '',
                '## 学び',
                '',
                action === '更新'
                  ? '- 修正版がある依存関係は、更新が最短のリスク低減策です'
                  : '- 修正版が未提供の場合は、影響範囲の把握と監視が重要です',
                '',
                '## 対応',
                '',
                `- 推奨: ${action}`,
                action === '更新'
                  ? '- 対応後は再スキャンで解消を確認してください'
                  : '- 修正版が出たら更新できるよう、定期的に確認してください',
                '',
                `最終更新: ${dateStamp} ${timeStamp} JST`
              ].join('\n');

              const existing = existingByTitle.get(title);
              if (existing) {
                await github.rest.issues.update({
                  owner,
                  repo,
                  issue_number: existing.number,
                  title,
                  body,
                  state: 'open'
                });
              } else {
                await github.rest.issues.create({
                  owner,
                  repo,
                  title,
                  body,
                  labels: [labelName]
                });
              }
            }

            for (const issue of existingIssues) {
              if (!issue.title.startsWith('脆弱性:')) continue;
              if (currentTitles.has(issue.title)) continue;
              if (issue.state === 'open') {
                await github.rest.issues.update({
                  owner,
                  repo,
                  issue_number: issue.number,
                  state: 'closed'
                });
              }
            }

      - name: Run Trivy scan (SARIF)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-results.sarif"
          severity: "CRITICAL,HIGH"
          ignore-unfixed: true
          exit-code: "0"

      - name: Upload SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: "trivy-results.sarif"

      - name: Fail if vulnerabilities found
        if: steps.findings.outputs.count != '0'
        run: exit 1
