name: Vulnerability Scan

on:
  schedule:
    - cron: "0 15 */5 * *"
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  issues: write

jobs:
  trivy:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Tokyo
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Trivy scan (JSON)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "json"
          output: "trivy-results.json"
          severity: "CRITICAL,HIGH"
          ignore-unfixed: true
          exit-code: "0"

      - name: Summarize findings
        id: findings
        run: |
          count=$(jq '[.Results[].Vulnerabilities[]?] | length' trivy-results.json)
          echo "count=$count" >> "$GITHUB_OUTPUT"

      - name: Create or update issue
        if: steps.findings.outputs.count != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const data = JSON.parse(fs.readFileSync('trivy-results.json', 'utf8'));
            const results = data.Results || [];
            const findings = [];
            for (const result of results) {
              const vulns = result.Vulnerabilities || [];
              for (const vuln of vulns) {
                findings.push({
                  id: vuln.VulnerabilityID || 'UNKNOWN',
                  severity: vuln.Severity || 'UNKNOWN',
                  pkg: vuln.PkgName || 'unknown',
                  installed: vuln.InstalledVersion || 'unknown',
                  fixed: vuln.FixedVersion || 'unfixed',
                  title: vuln.Title || vuln.Description || 'No description',
                  target: result.Target || 'unknown'
                });
              }
            }

            const severityOrder = { CRITICAL: 0, HIGH: 1, MEDIUM: 2, LOW: 3, UNKNOWN: 4 };
            const severityLabel = {
              CRITICAL: '致命的',
              HIGH: '高',
              MEDIUM: '中',
              LOW: '低',
              UNKNOWN: '不明'
            };
            findings.sort((a, b) => {
              const aRank = severityOrder[a.severity] ?? 9;
              const bRank = severityOrder[b.severity] ?? 9;
              if (aRank !== bRank) return aRank - bRank;
              return a.id.localeCompare(b.id);
            });

            const counts = findings.reduce((acc, item) => {
              acc[item.severity] = (acc[item.severity] || 0) + 1;
              return acc;
            }, {});

            const total = findings.length;
            const topItems = findings.slice(0, 50);
            const remaining = total - topItems.length;
            const fixableCount = findings.filter((item) => item.fixed && item.fixed !== 'unfixed').length;
            const unfixedCount = total - fixableCount;

            function topBy(field, limit) {
              const map = new Map();
              for (const item of findings) {
                const key = item[field] || 'unknown';
                map.set(key, (map.get(key) || 0) + 1);
              }
              return Array.from(map.entries())
                .sort((a, b) => b[1] - a[1])
                .slice(0, limit)
                .map(([key, count]) => `${key} (${count}件)`);
            }

            const topPackages = topBy('pkg', 5);
            const topTargets = topBy('target', 3);
            const rows = topItems.map((item) => (
              `| ${severityLabel[item.severity] || item.severity} | ${item.id} | ${item.pkg} | ${item.installed} | ${item.fixed} | ${item.target} | ${item.fixed && item.fixed !== 'unfixed' ? '更新' : '監視'} |`
            ));

            const summaryLines = Object.keys(counts)
              .sort((a, b) => (severityOrder[a] ?? 9) - (severityOrder[b] ?? 9))
              .map((key) => `- ${severityLabel[key] || key}: ${counts[key]}`);

            const now = new Date();
            const dateParts = new Intl.DateTimeFormat('ja-JP', {
              timeZone: 'Asia/Tokyo',
              year: 'numeric',
              month: '2-digit',
              day: '2-digit'
            }).formatToParts(now);
            const dateMap = Object.fromEntries(dateParts.map((part) => [part.type, part.value]));
            const dateStamp = `${dateMap.year}-${dateMap.month}-${dateMap.day}`;
            const timeStamp = new Intl.DateTimeFormat('ja-JP', {
              timeZone: 'Asia/Tokyo',
              hour: '2-digit',
              minute: '2-digit',
              second: '2-digit'
            }).format(now);

            const title = `脆弱性診断結果 (${dateStamp} ${timeStamp} JST)`;
            const labelName = 'vulnerability-scan';
            const body = [
              '## 概要',
              '',
              `検出件数: ${total}`,
              ...summaryLines,
              '',
              '## 学び（傾向）',
              '',
              `- 修正版あり: ${fixableCount}件 / 修正版待ち: ${unfixedCount}件`,
              topPackages.length > 0 ? `- 影響が多い依存関係: ${topPackages.join(', ')}` : null,
              topTargets.length > 0 ? `- 影響が集中する対象: ${topTargets.join(', ')}` : null,
              '',
              '## 対応のヒント',
              '',
              fixableCount > 0
                ? '- 修正版がある依存関係から順に更新すると、効率よくリスクを下げられます'
                : '- 修正版待ちが多いため、影響範囲の把握と監視を優先すると安全です',
              '',
              '## 検出内容（上位50件）',
              '',
              '| 重要度 | ID | パッケージ | インストール済み | 修正版 | 対象 | 対応 |',
              '| --- | --- | --- | --- | --- | --- | --- |',
              ...rows,
              '',
              remaining > 0 ? `他 ${remaining} 件` : null,
              '',
              `最終更新: ${timeStamp}`
            ].filter(Boolean).join('\n');

            const { owner, repo } = context.repo;

            async function ensureLabel() {
              try {
                await github.rest.issues.getLabel({ owner, repo, name: labelName });
              } catch (error) {
                if (error.status === 404) {
                  await github.rest.issues.createLabel({
                    owner,
                    repo,
                    name: labelName,
                    color: '0e8a16',
                    description: '自動脆弱性診断の結果'
                  });
                } else {
                  throw error;
                }
              }
            }

            await ensureLabel();

            await github.rest.issues.create({
              owner,
              repo,
              title,
              body,
              labels: [labelName]
            });

      - name: Run Trivy scan (SARIF)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-results.sarif"
          severity: "CRITICAL,HIGH"
          ignore-unfixed: true
          exit-code: "0"

      - name: Upload SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: "trivy-results.sarif"

      - name: Fail if vulnerabilities found
        if: steps.findings.outputs.count != '0'
        run: exit 1
